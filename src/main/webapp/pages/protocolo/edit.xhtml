<ui:composition template="/templates/layout.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:uivah="http://vah.com.br/vah">

  <ui:define name="metadata">
    <f:metadata>
      <f:viewParam name="id" value="#{protocoloController.id}"/>
      <f:viewAction action="#{protocoloController.onLoad}"/>
    </f:metadata>
  </ui:define>

  <ui:define name="content">

    <h:form id="form">

      <p:panel header="Enviar documentos">
        <h:panelGroup id="protocoloPnlWrapper" layout="block" style="position: relative">
          <p:focus context="protocoloPnlWrapper"/>

          <h:panelGrid id="grid01" columns="3">

            <uivah:autoComplete id="atendimento" value="#{protocoloController.item.atendimento}" label="Atendimento"
                                controller="#{atendimentoController}" completeMethod="completeAtendimento"
                                editing="#{protocoloController.editing and protocoloController.item.id == null}"
                                converter="#{atendimentoConverter}" itemLabel="labelForSelectItem"
                                placeholder="Número/Nome paciente">
              <p:ajax event="itemSelect" oncomplete="nextFocus('#{p:component('carregarDocsBtn')}')"/>
              <p:column>
                #{item.id}
              </p:column>
              <p:column>
                #{item.paciente.name}
              </p:column>
            </uivah:autoComplete>

            <uivah:inputDate id="inicioDate" label="Início"
                             value="#{protocoloController.inicioDate}"
                             editing="#{protocoloController.editing}"
                             pattern="dd/MM/yyyy"
                             rendered="#{protocoloController.item.id == null}"/>

            <uivah:inputDate id="terminoDate" label="Término"
                             value="#{protocoloController.terminoDate}"
                             editing="#{protocoloController.editing}"
                             pattern="dd/MM/yyyy"
                             rendered="#{protocoloController.item.id == null}"/>
          </h:panelGrid>

          <p:commandButton id="carregarDocsBtn" value="Buscar documentos" ajax="true"
                           process="@this grid01" update="tabView" validateClient="true"
                           styleClass="margin-top" action="#{protocoloController.buscarPrescricoes()}"
                           style="position: absolute; right: 0; top: 0; font-size: 20px;"
                           rendered="#{protocoloController.editing}"/>


        </h:panelGroup>

        <p:tabView id="tabView" value="#{protocoloController.documentos}" var="docEntry" styleClass="margin-top"
                   widgetVar="tabView">
          <p:tab id="preMedTab" title="#{docEntry.key}">

            <p:dataTable value="#{docEntry.value}" var="doc"
                         selection="#{protocoloController.mapSelectedDocumentos[docEntry.key]}" rowKey="#{doc.codigo}">

              <p:column selectionMode="multiple" width="16"/>

              <p:column headerText="Código" width="50" styleClass="left-align">
                <h:outputText value="#{doc.codigo}"/>
              </p:column>
              <p:column headerText="Prestador" styleClass="left-align">
                <h:outputText value="#{doc.prestador}"/>
              </p:column>
              <p:column headerText="Data/Hora criação" styleClass="left-align">
                <h:outputText value="#{doc.dataHoraCriacao}">
                  <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>
                </h:outputText>
              </p:column>
              <p:column headerText="Data/Hora impressão" styleClass="left-align">
                <h:outputText value="#{doc.dataHoraImpressao}">
                  <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss"/>
                </h:outputText>
              </p:column>
              <p:column headerText="Evolução" styleClass="left-align">
                <h:outputText value="#{doc.hasEvolucao}"/>
              </p:column>

            </p:dataTable>
          </p:tab>
          <p:tab id="prontuarioTab" title="Prontuários">
          </p:tab>
        </p:tabView>

        <h:panelGroup id="panelBtns" layout="block"
                      style="margin-top: 10px;">
          <p:commandButton id="saveBtn" value="Salvar" icon="fa fa-floppy-o" ajax="true"
                           process="@this form" update="form" validateClient="true"
                           style="margin-right:10px" action="#{protocoloController.doSave}"
                           rendered="#{protocoloController.editing}"/>
          <p:commandButton id="backBtn" value="Voltar" ajax="false" immediate="true" icon="fa fa-undo"
                           onstart="PF('changePage').show()"
                           action="#{protocoloController.back}"/>
        </h:panelGroup>
      </p:panel>
    </h:form>
  </ui:define>
</ui:composition>